---
title: "ACM_3_main"
output: html_document
date: "2024-02-22"
---

# Setup
```{r}
pacman::p_load(tidyverse, cmdstanr, brms, gridExtra, furrr)
```

# Simulate data

```{r}
# alien features (six features) (color, arms, eyes, dots, legs)
n <- 100

creature_data <- tibble(
  color = sample(c(0, 1), n, replace = TRUE),
  legs = sample(c(0, 1), n, replace = TRUE),
  eyes = sample(c(0, 1), n, replace = TRUE),
  dots = sample(c(0, 1), n, replace = TRUE),
  arms = sample(c(0, 1), n, replace = TRUE)
)

creature_data <- creature_data %>%
    mutate(category = ifelse(eyes == 1 & dots == 1, 1, 0))# 1 = danger, 0 = friendly

creature_data
```

# agent modelling
```{r}
# Weights
weights <- c(0.5, 0.2, 0.3, 0.4, 0.5)

# scaling parameter (vector of potential c-calues): tells how much similarty decayes with distance
c = c(0.1)

# distance function
distance <- function(vect1, vect2, w) {
    return(sum(w * abs(vect1 - vect2)))
}


# similarity function
similarity <- function(distance, c) {
    return(exp(-c * distance))
}

### generative model ###
gcm <- function(w, c, obs, cat_one, quiet = TRUE) {
  # variables description
  # w: weights
  # c: scaling parameter
  # obs: observed data
  # cat_one: category of each observation

  # create an empty list to save probability of saying "1" for each trial
  r <- c()
  
  ntrials <- nrow(obs)
  
  for (i in 1:ntrials) {
    # If quiet is FALSE, print every ten trials
    if (!quiet && i %% 10 == 0) {
      print(paste("i =", i))
    }
    # if this is the first trial, or there any category with no exemplars seen yet, set the choice to random
    if (i == 1 || sum(cat_one[1:(i - 1)]) == 0 || sum(cat_one[1:(i - 1)]) == (i - 1)) {
      r <- c(r, .5)
    } else {
      similarities <- c()
      # for each previously seen stimulus assess distance and similarity
      for (e in 1:(i - 1)) {
        sim <- similarity(distance(obs[i, ], obs[e, ], w), c)
        similarities <- c(similarities, sim)
      }
      # Calculate prob of saying "1" by dividing similarity to 1 by the sum of similarity to 1 and to 2
      numerator <- 0.5 * sum(similarities[cat_one[1:(i - 1)] == 1])
      denominator <- 0.5 * sum(similarities[cat_one[1:(i - 1)] == 1]) + 0.5 * sum(similarities[cat_one[1:(i - 1)] == 0])
      r <- c(r, numerator / denominator)
    }
  }

  return(rbinom(ntrials, 1, r))
}

```


```{r}
# Simulate choices function
simulate_responses <- function(agent, w, c) {
    
    observations <- creature_data # EOL: experiment should be our stimuli data (we should take creature data)

    
    category <- creature_data$category
    
    if (w == "equal") {
        weight <- rep(1 / 5, 5) # equally skewed
    } else if (w == "skewed1") { # a little but skewed
        weight <- c(0.1, 0.1,0.1,0.3,0.4)
    } else if (w == "skewed2") { # extremely skewed
        weight <- c(0.0, 0.0, 0.0, 0.0, 1)
    }

    # simulate responses
    responses <- gcm(
        weight,
        c,
        observations,
        category
    )
    
    tmp_simulated_responses <- creature_data %>%
        mutate(
            trial = seq(nrow(creature_data)),
            sim_response = responses,
            correct = ifelse(category == sim_response, 1, 0),
            performance = cumsum(correct) / seq_along(correct),
            c = c,
            w = w,
            agent = agent
        )

    return(tmp_simulated_responses)
}

# actually simulate the data
# simulate responses
plan(multisession, workers = availableCores())

param_df <- dplyr::tibble(
    expand_grid(
        agent = 1:10,
        c = seq(.1, 10, 1), # 0.1 to 6 with 0.2 increments 
        w = c("equal", "skewed1", "skewed2")
    )
)

simulated_responses <- future_pmap_dfr(param_df,
    simulate_responses,
    .options = furrr_options(seed = TRUE)
)

```

```{r}
simulated_responses
```

Plotting
```{r}
p3 <- simulated_responses %>%
  mutate(w = as.factor(w)) %>%
  ggplot(aes(trial, performance, group = w, color = w)) +
  geom_smooth() +
  theme_bw() +
  facet_wrap(c ~ .)

# # save to drive
ggsave("p3.png", p3, width = 10, height = 10)

p4 <- simulated_responses %>%
  mutate(c = as.factor(c)) %>%
  ggplot(aes(trial, performance, group = c, color = c)) +
  geom_smooth() +
  theme_bw() +
  facet_wrap(w ~ .)

commbined_simulated <- grid.arrange(p3, p4, ncol = 1)
commbined_simulated

ggsave("figures/combined_simulated.png", commbined_simulated, width = 10, height = 10)

```

Compiling stan model
```{r}
file <- file.path("stan_model/GCM.stan")

GCM_mod <- cmdstan_model(file, cpp_options = list(stan_threads = TRUE), stanc_options = list("O1"), pedantic = TRUE)
```

```{r}
simulated_responses
```

```{r}
head(creature_data,1)
```

Fitting the model to simulated data
```{r}
d <- simulated_responses %>% subset(
  c == "7.1" & w == "equal"
)
```

```{r}


gcm_data <- list(
  ntrials = nrow(d),
  nfeatures = 5,
  cat_one = d$category,
  y = d$sim_response,
  obs = as.matrix(d[, c("color",  "legs",  "eyes",  "dots",  "arms")]),
  b = 0.5,
  w_prior_values = c(1,1,1,1,1),
  c_prior_values = c(0, 1) # 0 = mean, 1 = variance
)

samples_gcm <- GCM_mod$sample(
  data = gcm_data,
  seed = 123,
  chains = 2,
  parallel_chains = 1,
  threads_per_chain = 4,
  iter_warmup = 1000,
  iter_sampling = 1000,
  refresh = 500
)
```

```{r}
#samples_gcm$save_object("simmodels/GCM_sim.rds")
samples <- readRDS("simmodels/GCM_real.rds")
```


# assessing model diagnostics
```{r}
# diagnosing the mdoel
samples_gcm$cmdstan_diagnose()
```

# model summary
```{r}
# sumarizing model
samples_gcm$summary()
```

# draws DF trace Plotting
```{r}
draws_df <- as_draws_df(samples_gcm$draws())

c_trace <- ggplot(draws_df, aes(.iteration, c, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

c_trace

ggsave("figures/c_trace_sim.png", c_trace, width = 10, height = 10)

```

```{r}
# logit_c
logit_c_trace <- ggplot(draws_df, aes(.iteration, logit_c, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

logit_c_trace
ggsave("figures/logit_c_trace_sim.png", logit_c_trace, width = 10, height = 10)
```

```{r}
# trace plot for each weight
w1_trace <- ggplot(draws_df, aes(.iteration, `w[1]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w2_trace <- ggplot(draws_df, aes(.iteration, `w[2]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w3_trace <- ggplot(draws_df, aes(.iteration, `w[3]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w4_trace <- ggplot(draws_df, aes(.iteration, `w[4]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w5_trace <- ggplot(draws_df, aes(.iteration, `w[5]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

# plot all weight trace plots in one 
weights_trace <- grid.arrange(w1_trace, w2_trace, w3_trace, w4_trace, w5_trace, ncol = 2)
ggsave("figures/weights_trace_sim.png", weights_trace, width = 10, height = 10)

```

# prior posterior pred plots

```{r}

c_post_pred <- ggplot(draws_df) +
  geom_histogram(aes(c), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(c_prior), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = d$c[1]) +
  theme_bw()

c_post_pred
ggsave("figures/c_post_pred_sim.png", c_post_pred, width = 10, height = 10)
```

```{r}

logit_c_postpred <- ggplot(draws_df) +
  geom_histogram(aes(logit_c), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(logit_c_prior), alpha = 0.6, fill = "pink") +
  theme_bw()

logit_c_postpred
ggsave("figures/logit_c_postpred_sim.png", logit_c_postpred, width = 10, height = 10)
```


```{r}
w1_plot = ggplot(draws_df) +
  geom_histogram(aes(`w[1]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[1]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w2_plot = ggplot(draws_df) +
  geom_histogram(aes(`w[2]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[2]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w3_plot = ggplot(draws_df) +
  geom_histogram(aes(`w[3]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[3]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w4_plot = ggplot(draws_df) +
  geom_histogram(aes(`w[4]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[4]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w5_plot = ggplot(draws_df) +
  geom_histogram(aes(`w[5]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[5]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

# combined weight trace plots
combined_weight_traces <- grid.arrange(w1_plot, w2_plot, w3_plot, w4_plot, w5_plot, ncol = 2)
combined_weight_traces

ggsave("figures/combined_weight_postpred_sim.png", combined_weight_traces, width = 10, height = 10)
```

# posterior cloud plots 

```{r}
cloud_plots <- list()

for (i in 1:5) {
  # create plot for each w[i]
  cloud_plots[[i]] <- ggplot(draws_df, aes_string(x = "c", y = paste("`w[", i, "]`", sep = ""))) +
    geom_point(alpha = 0.6, color = "lightblue") +
    theme_bw() +
    ggtitle(paste("Plot of w[", i, "]", sep = ""))
}

# display all plots looping through the plots list
for (plot in cloud_plots) {
  print(plot)
}
```

# on real data
```{r}
# read and filter the data
exp_data <- read_csv("data/AlienData.txt") %>%
  filter(session == 1, subject == 1)

# function to process stimulus data
process_stimulus <- function(stimulus) { 
  str_replace_all(stimulus, ".jpg|pt", "") %>% # remove occurences of .jpg and pt from stimulus string using regex
    str_split("") %>% # split the cleaned string into indiv characters
    unlist() %>% # converts the list of characters into a vector
    matrix(ncol = 5, byrow = TRUE) %>% # convert the vector into a matrix with 5 columns, fil it by rows w vector elements
    as.data.frame() # convert the matrix into a data frame where each col is a feature derived from the stimulus
}

# apply the function to each stimulus and bind rows
stimulus <- do.call(rbind, lapply(exp_data$stimulus, process_stimulus)) # applies func to each element of exp_data$stimulus, returns list of data frames, binds them by rows

# Add features to exp_data
feature_names <- paste0("f", 1:5) # generates feature names that are f1, f2, f3, f4, f5, we could consider calling them color, arms, eyes, dots, legs 
names(stimulus) <- feature_names # sets the column names of the new 'stimulus' data frame to the feature names
exp_data[feature_names] <- lapply(stimulus, as.numeric) # adds the numeric versions of the features to corresponding new columns in exp_data 


exp_data <- exp_data %>%
  mutate( 
    category = as.integer(category %% 2 == 0), # if category is even, set to 0, else set to 1
    response = as.integer(response %% 2 == 0), # if response is even, set to 0, else set to 1
    correct = as.integer(category == response) # if category is equal to response, set to 1, else set to 0
  )

```

fitting on real data

```{r}

# file <- file.path("stan_model/GCM.stan") this we already have 
# GCM_mod <- cmdstan_model(file, cpp_options = list(stan_threads = TRUE), stanc_options = list("O1"), pedantic = TRUE) this we already have
```


```{r}
gcm_data_real <- list(
  ntrials = nrow(exp_data),
  nfeatures = 5,
  cat_one = exp_data$category,
  y = exp_data$response,
  obs = as.matrix(exp_data[, c("f1",  "f2",  "f3",  "f4",  "f5")]),
  b = 0.5,
  w_prior_values = c(1,1,1,1,1),
  c_prior_values = c(0, 1) # 0 = mean, 1 = variance
)

samples_gcm_real <- GCM_mod$sample(
  data = gcm_data_real,
  seed = 123,
  chains = 2,
  parallel_chains = 2,
  threads_per_chain = 3,
  iter_warmup = 1000,
  iter_sampling = 1000,
  refresh = 500
)

```
```{r}
samples_gcm_real$save_object("simmodels/GCM_real.rds")
#samples <- readRDS("simmodels/GCM_read.rds")
```


# asses the model fit on experimental data

# assessing model diagnostics
```{r}
# diagnosing the mdoel
samples_gcm_real$cmdstan_diagnose()
```

# model summary
```{r}
# sumarizing model
samples_gcm_real$summary()
```

# draws DF trace Plotting
```{r}
draws_df_real <- as_draws_df(samples_gcm_real$draws())

c_trace_real <- ggplot(draws_df_real, aes(.iteration, c, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

c_trace_real

ggsave("figures/c_trace_real.png", c_trace_real, width = 10, height = 10)

```

```{r}
# logit_c
logit_c_trace_real <- ggplot(draws_df_real, aes(.iteration, logit_c, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

logit_c_trace_real
ggsave("figures/logit_c_trace_real.png", logit_c_trace_real, width = 10, height = 10)
```

```{r}
# trace plot for each weight
w1_trace_real <- ggplot(draws_df_real, aes(.iteration, `w[1]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w2_trace_real <- ggplot(draws_df_real, aes(.iteration, `w[2]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w3_trace_real <- ggplot(draws_df_real, aes(.iteration, `w[3]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w4_trace_real <- ggplot(draws_df_real, aes(.iteration, `w[4]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

w5_trace_real <- ggplot(draws_df_real, aes(.iteration, `w[5]`, group = .chain, color = .chain)) +
  geom_line(alpha = 0.5) +
  theme_classic()

# plot all weight trace plots in one 
weights_trace_real <- grid.arrange(w1_trace_real, w2_trace_real, w3_trace_real, w4_trace_real, w5_trace_real, ncol = 2)
ggsave("figures/weights_trace_real.png", weights_trace_real, width = 10, height = 10)

```

# prior posterior pred plots

```{r}

c_post_pred_real <- ggplot(draws_df_real) +
  geom_histogram(aes(c), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(c_prior), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = d$c[1]) +
  theme_bw()

c_post_pred_real
ggsave("figures/c_post_pred_real.png", c_post_pred_real, width = 10, height = 10)
```

```{r}

logit_c_postpred_real <- ggplot(draws_df_real) +
  geom_histogram(aes(logit_c), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(logit_c_prior), alpha = 0.6, fill = "pink") +
  theme_bw()

logit_c_postpred_real
ggsave("figures/logit_c_postpred__real.png", logit_c_postpred_real, width = 10, height = 10)
```


```{r}
w1_plot_real = ggplot(draws_df_real) +
  geom_histogram(aes(`w[1]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[1]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w2_plot_real = ggplot(draws_df_real) +
  geom_histogram(aes(`w[2]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[2]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w3_plot_real = ggplot(draws_df_real) +
  geom_histogram(aes(`w[3]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[3]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w4_plot_real = ggplot(draws_df_real) +
  geom_histogram(aes(`w[4]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[4]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

w5_plot_real = ggplot(draws_df_real) +
  geom_histogram(aes(`w[5]`), alpha = 0.6, fill = "lightblue") +
  geom_histogram(aes(`w_prior[5]`), alpha = 0.6, fill = "pink") +
  geom_vline(xintercept = 0.2) +
  theme_bw()

# combined weight trace plots
combined_weight_traces_real <- grid.arrange(w1_plot_real, w2_plot_real, w3_plot_real, w4_plot_real, w5_plot_real, ncol = 2)
combined_weight_traces_real

ggsave("figures/combined_weight_postpred__real.png", combined_weight_traces_real, width = 10, height = 10)
```

# posterior cloud plots 

```{r}
cloud_plots_real <- list()

for (i in 1:5) {
  # create plot for each w[i]
  cloud_plots_real[[i]] <- ggplot(draws_df_real, aes_string(x = "c", y = paste("`w[", i, "]`", sep = ""))) +
    geom_point(alpha = 0.6, color = "lightblue") +
    theme_bw() +
    ggtitle(paste("Plot of w[", i, "]", sep = ""))
}

# display all plots looping through the plots list
for (plot in cloud_plots_real) {
  print(plot)
}
```
